<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nugget - Gerenciador de Ativos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            --brand-color: #fcd34d; /* yellow-300 */
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background-color: #475569; border-radius: 10px; border: 2px solid #1e293b; }
        ::-webkit-scrollbar-thumb:hover { background-color: #64748b; }
        
        .form-input, .form-select, .form-textarea {
            background-color: #1e293b;
            border: 1px solid #334155;
            color: #cbd5e1;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--brand-color);
            box-shadow: 0 0 0 2px #b45309; /* amber-700 */
        }
        .btn-primary {
            background-color: #f59e0b; /* amber-500 */
            color: black;
            font-weight: 600;
            padding: 0.6rem 1.2rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #d97706; /* amber-600 */
        }
        .nav-link.active {
            background-color: #475569; /* slate-600 */
        }

        /* Modal specific style for fixed positioning and background */
        #confirmation-modal {
            background-color: rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300">

    <!-- Login View (Usando o mesmo molde do SodaPop) -->
    <div id="login-view" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-8 bg-slate-800 rounded-lg shadow-lg">
            <div class="text-center">
                 <i class="fa-solid fa-gem text-5xl mx-auto" style="color: var(--brand-color);"></i>
                <h2 class="mt-6 text-3xl font-bold text-white">Bem-vindo ao Nugget</h2>
                <p class="mt-2 text-sm text-slate-400">Acesso administrativo</p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <div>
                        <label for="username" class="sr-only">Usuário</label>
                        <input id="username" name="username" type="text" required class="form-input rounded-t-md" placeholder="Usuário">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Senha</label>
                        <input id="password" name="password" type="password" required class="form-input rounded-b-md" placeholder="Senha">
                    </div>
                </div>
                 <p id="login-error" class="text-red-400 text-sm text-center hidden"></p>
                <div>
                    <button type="submit" id="login-button" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white" style="background-color: var(--brand-color); color: black !important;">
                        Entrar
                    </button>
                </div>
            </form>
        </div>
    </div>


    <div id="app" class="hidden flex-col min-h-screen">
        <!-- Header -->
        <header class="bg-slate-800/50 backdrop-blur-sm border-b border-slate-700 sticky top-0 z-20">
            <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-6">
                        <div class="flex items-center space-x-4">
                            <i class="fa-solid fa-gem text-3xl" style="color: var(--brand-color);"></i>
                            <h1 class="text-xl font-bold text-white">Nugget</h1>
                        </div>
                        
                        <!-- Novo Menu de Navegação -->
                        <div class="flex items-center space-x-2">
                             <button id="nav-videos" data-view="videos" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-white hover:bg-slate-700 active">
                                <i class="fa-solid fa-video mr-2"></i> Vídeos Loom
                             </button>
                             <button id="nav-arquivos" data-view="arquivos" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-white hover:bg-slate-700">
                                <i class="fa-solid fa-folder-open mr-2"></i> Arquivos/Links
                             </button>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="index.html" class="px-3 py-2 rounded-md text-sm font-medium text-white hover:bg-slate-700">SodaPop</a>
                        <button id="logout-button" class="text-slate-400 hover:text-white" title="Sair"><i class="fa-solid fa-right-from-bracket"></i></button>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Main Content -->
        <main id="main-content" class="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
            <h2 class="text-3xl font-bold text-white mb-6" id="view-title">Gerenciamento de Vídeos Loom</h2>

            <div id="loading" class="text-center p-8 hidden">
                 <i class="fa-solid fa-spinner fa-spin text-2xl" style="color: var(--brand-color);"></i>
                <p class="text-sm text-slate-400 mt-2">Carregando dados de projetos...</p>
            </div>
            
            <div id="content-container">
                 <!-- VIEW: VÍDEOS -->
                <div id="view-videos" class="space-y-12">
                    <div class="bg-slate-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-2xl font-semibold text-white mb-4 flex items-center gap-3">
                            <i class="fa-solid fa-video" style="color: var(--brand-color);"></i> Cadastro de Novo Vídeo
                        </h3>
                        <form id="form-video" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="video-sistema" class="block text-sm font-medium mb-1">Projeto (Sistema)</label>
                                    <select id="video-sistema" class="form-select" required></select>
                                </div>
                                <div>
                                    <label for="video-funcionalidade" class="block text-sm font-medium mb-1">Funcionalidade</label>
                                    <select id="video-funcionalidade" class="form-select" required></select>
                                </div>
                                <div>
                                    <label for="video-tag" class="block text-sm font-medium mb-1">Tag (Ex: Treinamento, Demo)</label>
                                    <input type="text" id="video-tag" class="form-input" placeholder="Tag de categorização">
                                </div>
                            </div>
                            
                            <div>
                                <label for="video-titulo" class="block text-sm font-medium mb-1">Título do Vídeo</label>
                                <input type="text" id="video-titulo" class="form-input" required placeholder="Ex: Demonstração da Nova Tela de Login">
                            </div>
                            
                            <div>
                                <label for="video-url" class="block text-sm font-medium mb-1">URL do Loom (Link de Compartilhamento)</label>
                                <input type="url" id="video-url" class="form-input" required placeholder="https://www.loom.com/share/...">
                            </div>
                            
                            <div>
                                <label for="video-descricao" class="block text-sm font-medium mb-1">Descrição</label>
                                <textarea id="video-descricao" rows="3" class="form-textarea" placeholder="Breve contexto do vídeo."></textarea>
                            </div>

                            <button type="submit" id="btn-salvar-video" class="btn-primary flex items-center gap-2">
                                <i class="fa-solid fa-save"></i> Salvar Vídeo
                            </button>
                        </form>
                    </div>

                    <!-- Listagem de Vídeos -->
                    <div class="bg-slate-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-2xl font-semibold text-white mb-4 flex items-center gap-3">
                            <i class="fa-solid fa-list" style="color: var(--brand-color);"></i> Vídeos Cadastrados
                            <span id="videos-count" class="text-sm text-slate-400 font-normal"></span>
                        </h3>
                        <!-- Filtros e Tabela serão injetados aqui -->
                        <div id="video-list-container">
                             <p class="text-center text-slate-500">Carregando vídeos...</p>
                        </div>
                    </div>
                </div>
                
                 <!-- VIEW: ARQUIVOS -->
                <div id="view-arquivos" class="space-y-12 hidden">
                    <div class="bg-slate-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-2xl font-semibold text-white mb-4 flex items-center gap-3">
                            <i class="fa-solid fa-folder-open" style="color: var(--brand-color);"></i> Cadastro de Novo Arquivo/Link
                        </h3>
                        <form id="form-arquivo" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="arquivo-sistema" class="block text-sm font-medium mb-1">Projeto (Sistema)</label>
                                    <select id="arquivo-sistema" class="form-select" required></select>
                                </div>
                                <div>
                                    <label for="arquivo-categoria" class="block text-sm font-medium mb-1">Categoria (Ex: Contratos, Briefing)</label>
                                    <input type="text" id="arquivo-categoria" class="form-input" required placeholder="Categoria de Agrupamento">
                                </div>
                            </div>
                            
                            <div>
                                <label for="arquivo-titulo" class="block text-sm font-medium mb-1">Título do Arquivo</label>
                                <input type="text" id="arquivo-titulo" class="form-input" required placeholder="Ex: Contrato Assinado - 2025">
                            </div>
                            
                            <div>
                                <label for="arquivo-url" class="block text-sm font-medium mb-1">URL do Arquivo/Link (Google Drive, PDF, etc.)</label>
                                <input type="url" id="arquivo-url" class="form-input" required placeholder="https://drive.google.com/...">
                            </div>
                            
                            <div>
                                <label for="arquivo-descricao" class="block text-sm font-medium mb-1">Descrição</label>
                                <textarea id="arquivo-descricao" rows="3" class="form-textarea" placeholder="Breve contexto do arquivo."></textarea>
                            </div>

                            <button type="submit" id="btn-salvar-arquivo" class="btn-primary flex items-center gap-2">
                                <i class="fa-solid fa-save"></i> Salvar Arquivo
                            </button>
                        </form>
                    </div>

                    <!-- Listagem de Arquivos -->
                    <div class="bg-slate-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-2xl font-semibold text-white mb-4 flex items-center gap-3">
                            <i class="fa-solid fa-list" style="color: var(--brand-color);"></i> Arquivos/Links Cadastrados
                            <span id="arquivos-count" class="text-sm text-slate-400 font-normal"></span>
                        </h3>
                        <!-- Filtros e Tabela serão injetados aqui -->
                        <div id="arquivo-list-container">
                             <p class="text-center text-slate-500">Carregando arquivos...</p>
                        </div>
                    </div>
                </div>
            </div>

        </main>
        
        <!-- Footer -->
        <footer class="bg-slate-800/50 border-t border-slate-700 text-center py-4">
            <p class="text-xs text-slate-500">ProdutiveMe | Nugget v1.0</p>
        </footer>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden">
        <p id="toast-message"></p>
    </div>

    <!-- Modal de Edição/Visualização (Reutilizável) -->
    <div id="main-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4">
        <div id="modal-content" class="bg-slate-800 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <!-- Conteúdo do modal (formulário de edição) -->
        </div>
    </div>

     <!-- Modal de Confirmação (Novo para Exclusão) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden items-center justify-center p-4">
        <div id="confirm-modal-content" class="bg-slate-800 rounded-lg shadow-xl w-full max-w-sm p-6 text-center">
            <i class="fa-solid fa-triangle-exclamation text-4xl text-red-500 mb-4"></i>
            <h3 class="text-lg font-bold text-white mb-2">Confirmação de Exclusão</h3>
            <p id="confirm-message" class="text-sm text-slate-300 mb-6">Tem certeza que deseja apagar este item? Esta ação não pode ser desfeita.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-btn" class="bg-slate-600 hover:bg-slate-500 text-white px-4 py-2 rounded-md text-sm font-medium">Cancelar</button>
                <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm font-medium">Excluir</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            const state = {
                isAuthenticated: false,
                currentUser: null,
                sistemas: [],
                funcionalidades: [],
                videos: [], // Armazenar os vídeos
                arquivos: [], // NOVO: Armazenar os arquivos/links
                currentView: 'videos',
                // Estados para os filtros de Vídeos
                filterSistemaId: '',
                filterTag: '',
                // NOVO: Estados para os filtros de Arquivos
                filterArquivoSistemaId: '',
                filterArquivoCategoria: '',
            };

            // --- DOM ELEMENTS ---
            const loginViewEl = document.getElementById('login-view');
            const appViewEl = document.getElementById('app');
            const loginFormEl = document.getElementById('login-form');
            const loginErrorEl = document.getElementById('login-error');
            const loginButtonEl = document.getElementById('login-button');
            const logoutButtonEl = document.getElementById('logout-button');
            const loadingEl = document.getElementById('loading');
            
            const formVideoEl = document.getElementById('form-video');
            const formArquivoEl = document.getElementById('form-arquivo');
            const videoSistemaSelect = document.getElementById('video-sistema');
            const videoFuncionalidadeSelect = document.getElementById('video-funcionalidade');
            const arquivoSistemaSelect = document.getElementById('arquivo-sistema');
            const btnSalvarVideo = document.getElementById('btn-salvar-video');
            const btnSalvarArquivo = document.getElementById('btn-salvar-arquivo');

            const viewVideosEl = document.getElementById('view-videos');
            const viewArquivosEl = document.getElementById('view-arquivos');
            const viewTitleEl = document.getElementById('view-title');
            const navLinks = document.querySelectorAll('.nav-link');

            const videoListContainer = document.getElementById('video-list-container');
            const videosCountEl = document.getElementById('videos-count');
            
            // Elementos de listagem e contagem de arquivos
            const arquivoListContainer = document.getElementById('arquivo-list-container');
            const arquivosCountEl = document.getElementById('arquivos-count');
            
            // Elementos de filtro da listagem de vídeos
            let videoFilterSistemaSelect; 
            let videoFilterTagSelect;
            // Elementos de filtro da listagem de arquivos
            let arquivoFilterSistemaSelect;
            let arquivoFilterCategoriaSelect;


            const toastEl = document.getElementById('toast');
            const toastMessageEl = document.getElementById('toast-message');
            const mainModalEl = document.getElementById('main-modal');
            const modalContentEl = document.getElementById('modal-content');
            
            // Elementos do Modal de Confirmação
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmMessageEl = document.getElementById('confirm-message');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

            // --- N8N WEBHOOK URLS ---
            const URLS = {
                login: 'https://work.produ-cloud.com/webhook/envia_login', 
                getSistemas: 'https://work.produ-cloud.com/webhook/carrega_todos_sistemas', 
                getFuncionalidades: 'https://work.produ-cloud.com/webhook/carrega_todas_funcionalidades',
                getVideos: 'https://work.produ-cloud.com/webhook/nugget-busca-video', 
                getArquivos: 'https://work.produ-cloud.com/webhook/nugget-busca-arquivos', 
                // Rotinas de Escrita
                saveVideo: 'https://work.produ-cloud.com/webhook/nugget-salva-video', 
                saveArquivo: 'https://work.produ-cloud.com/webhook/nugget_arquivos_links',
                // Rotinas de Exclusão (NOVAS)
                deleteVideo: 'https://work.produ-cloud.com/webhook/nugget-exclui-video',
                deleteArquivo: 'https://work.produ-cloud.com/webhook/nugget-exclui-arquivo',
            };
            
            // --- UTILITIES ---
            const showToast = (message, isError = false) => {
                toastMessageEl.textContent = message;
                toastEl.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
                toastEl.classList.remove('hidden');
                setTimeout(() => { toastEl.classList.add('hidden'); }, 3000);
            };

            const formatDate = (dateString) => {
                if (!dateString) return 'N/D';
                const date = new Date(dateString);
                 return date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', year: 'numeric', timeZone: 'UTC' });
            };
            
            const getIconForUrl = (url) => {
                const lowerUrl = url.toLowerCase();
                if (lowerUrl.includes('drive.google.com') || lowerUrl.includes('.pdf')) return 'fa-file-pdf';
                if (lowerUrl.includes('youtube.com') || lowerUrl.includes('vimeo.com') || lowerUrl.includes('loom.com')) return 'fa-video';
                if (lowerUrl.includes('docs.google.com/document')) return 'fa-file-word';
                if (lowerUrl.includes('docs.google.com/spreadsheets')) return 'fa-file-excel';
                return 'fa-link';
            };


            const openModal = (content) => {
                modalContentEl.innerHTML = content;
                mainModalEl.classList.remove('hidden');
                mainModalEl.classList.add('flex');
            };

            const closeModal = () => {
                mainModalEl.classList.add('hidden');
                mainModalEl.classList.remove('flex');
                modalContentEl.innerHTML = '';
            };
            
            function showConfirmationModal(message, callback) {
                confirmMessageEl.innerHTML = message; // Use innerHTML para suportar formatação simples (ex: **titulo**)
                confirmationModal.classList.remove('hidden');
                confirmationModal.classList.add('flex');

                // Garante que os listeners anteriores sejam removidos para evitar execuções duplicadas
                confirmDeleteBtn.onclick = null;
                cancelDeleteBtn.onclick = null;
                
                confirmDeleteBtn.onclick = () => {
                    confirmationModal.classList.add('hidden');
                    callback(true);
                };

                cancelDeleteBtn.onclick = () => {
                    confirmationModal.classList.add('hidden');
                    callback(false);
                };
            }


            // --- AUTHENTICATION & API ---
            async function authenticatedFetch(url, options = {}) {
                const token = sessionStorage.getItem('pass_jwt_token');
                
                if (!token) {
                    handleLogout();
                    return Promise.reject(new Error('Sessão de administrador expirada.'));
                }

                const headers = {
                    ...options.headers,
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                };
                
                // Adiciona o método 'POST' explicitamente se não estiver definido
                const defaultOptions = { 
                    method: options.method || 'GET', 
                    ...options, 
                    headers: headers 
                };

                // Remove 'body' se o método não for POST/PUT (evita erros em GET/DELETE)
                if (defaultOptions.method === 'GET' || defaultOptions.method === 'DELETE') {
                    delete defaultOptions.body;
                }

                try {
                    const response = await fetch(url, defaultOptions);
                    
                    if (!response.ok && response.status !== 404 && response.status !== 400) { 
                        if (response.status === 401 || response.status >= 500) { 
                            handleLogout();
                            throw new Error('Erro de autenticação ou servidor. Tentando relogar.');
                        }
                    }
                    
                    return response;
                } catch(error) {
                    // Captura o TypeError: Failed to fetch (geralmente CORS, URL inválida ou rede)
                    console.error("Fetch Error:", error.message, url);
                    throw new Error("Falha na comunicação com o servidor. Verifique a URL e CORS.");
                }
            }

            function checkAuth() {
                const user = sessionStorage.getItem('sodapop_user');
                const token = sessionStorage.getItem('pass_jwt_token'); 
                
                if (user && token) {
                    state.isAuthenticated = true;
                    state.currentUser = JSON.parse(user);
                    loginViewEl.classList.add('hidden');
                    appViewEl.classList.remove('hidden');
                    appViewEl.classList.add('flex');
                    fetchInitialData();
                } else {
                    loginViewEl.classList.remove('hidden');
                    appViewEl.classList.add('hidden');
                }
            }

            async function handleLogin(e) {
                e.preventDefault();
                loginButtonEl.disabled = true;
                loginButtonEl.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Entrando...`;
                loginErrorEl.classList.add('hidden');

                const username = loginFormEl.username.value;
                const password = loginFormEl.password.value;

                try {
                    const response = await fetch(URLS.login, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    
                    if (!response.ok) throw new Error('Falha na comunicação com o servidor.');
                    
                    const result = await response.json();
                    const loginData = Array.isArray(result) ? result[0] : result;
                    
                    if (loginData && loginData.id && loginData.username) {
                        const simulatedToken = `dummy_admin_token_${loginData.id}_${Date.now()}`;
                        
                        sessionStorage.setItem('pass_jwt_token', simulatedToken); 
                        sessionStorage.setItem('sodapop_user', JSON.stringify(loginData)); 
                        checkAuth();
                    } else {
                         throw new Error('Usuário ou senha inválidos.');
                    }
                } catch (error) {
                    loginErrorEl.textContent = error.message;
                    loginErrorEl.classList.remove('hidden');
                } finally {
                    loginButtonEl.disabled = false;
                    loginButtonEl.innerHTML = 'Entrar';
                }
            }

            function handleLogout() {
                sessionStorage.removeItem('sodapop_user');
                sessionStorage.removeItem('pass_jwt_token');
                checkAuth();
            }

            // --- DATA OPERATIONS ---
            async function fetchInitialData() {
                loadingEl.classList.remove('hidden');
                try {
                    // Carrega todos os dados em paralelo
                    const [sistemasRes, funcsRes, videosRes, arquivosRes] = await Promise.all([
                        authenticatedFetch(URLS.getSistemas, { method: 'GET' }), 
                        authenticatedFetch(URLS.getFuncionalidades, { method: 'GET' }),
                        authenticatedFetch(URLS.getVideos, { method: 'GET' }),
                        authenticatedFetch(URLS.getArquivos, { method: 'GET' })
                    ]);

                    if (!sistemasRes.ok || !funcsRes.ok) {
                        const errorMsg = `Falha ao carregar sistemas/funcionalidades. Verifique as URLs do N8N.`;
                         throw new Error(errorMsg);
                    }
                    
                    // Processamento e tratamento de falhas individuais na busca de ativos
                    state.sistemas = await sistemasRes.json();
                    state.funcionalidades = await funcsRes.json();
                    
                    // --- Processamento Robusto de Vídeos ---
                    if (videosRes.ok) {
                        try {
                            const data = await videosRes.json();
                            state.videos = Array.isArray(data) ? data : [];
                        } catch (e) {
                            state.videos = [];
                            console.warn("Vídeos: Resposta não era JSON válido ou estava vazia.", e);
                        }
                    } else {
                        console.error("Falha na requisição de Vídeos:", videosRes.status);
                    }

                    // --- Processamento Robusto de Arquivos ---
                    if (arquivosRes.ok) {
                        try {
                            const data = await arquivosRes.json();
                            state.arquivos = Array.isArray(data) ? data : [];
                        } catch (e) {
                            state.arquivos = [];
                            console.warn("Arquivos: Resposta não era JSON válido ou estava vazia.", e);
                        }
                    } else {
                        console.error("Falha na requisição de Arquivos:", arquivosRes.status);
                    }


                    if (state.sistemas.length === 0) {
                        showToast('Nenhum projeto encontrado. Verifique a fonte de dados.', true);
                    }
                    
                    populateSelects();
                    
                    // Chama as funções de listagem após o carregamento dos dados,
                    // garantindo que as listas estejam preenchidas antes da primeira renderização
                    renderListagemVideos();
                    renderListagemArquivos();


                } catch (error) {
                    showToast(error.message || 'Erro ao carregar dados iniciais. (Rede/Auth)', true);
                } finally {
                    loadingEl.classList.add('hidden');
                    renderView();
                }
            }
            
            // --- DELETION LOGIC (NOVAS FUNÇÕES) ---

            async function handleDeleteVideo(id) {
                const video = state.videos.find(v => String(v.id) === String(id));
                const message = `Deseja realmente excluir o vídeo: **${video ? video.titulo : 'ID ' + id}**?`;
                
                showConfirmationModal(message, async (confirm) => {
                    if (confirm) {
                        try {
                            const response = await authenticatedFetch(URLS.deleteVideo, {
                                method: 'POST',
                                body: JSON.stringify({ id: id })
                            });

                            // VERIFICAÇÃO AJUSTADA: Aceita status 200 como sucesso (resposta noData do N8N)
                            if (response.status !== 200) {
                                throw new Error(`Falha ao excluir o vídeo (Status: ${response.status}).`);
                            }
                            
                            showToast('Vídeo excluído com sucesso!');
                            await fetchInitialData(); // Recarrega para atualizar a lista
                        } catch (error) {
                            console.error('Erro ao excluir vídeo:', error);
                            showToast(error.message, true);
                        }
                    }
                });
            }

            async function handleDeleteArquivo(id) {
                 const arquivo = state.arquivos.find(a => String(a.id) === String(id));
                 const message = `Deseja realmente excluir o arquivo: **${arquivo ? arquivo.titulo : 'ID ' + id}**?`;

                 showConfirmationModal(message, async (confirm) => {
                    if (confirm) {
                        try {
                            const response = await authenticatedFetch(URLS.deleteArquivo, {
                                method: 'POST',
                                body: JSON.stringify({ id: id })
                            });

                            // VERIFICAÇÃO AJUSTADA: Aceita status 200 como sucesso (resposta noData do N8N)
                            if (response.status !== 200) {
                                throw new Error(`Falha ao excluir o arquivo (Status: ${response.status}).`);
                            }
                            
                            showToast('Arquivo excluído com sucesso!');
                            await fetchInitialData(); // Recarrega para atualizar a lista
                        } catch (error) {
                            console.error('Erro ao excluir arquivo:', error);
                            showToast(error.message, true);
                        }
                    }
                });
            }


            function populateSelects() {
                const sistemaOptions = state.sistemas.map(s => `<option value="${String(s.id)}">${s.name}</option>`).join('');
                
                videoSistemaSelect.innerHTML = `<option value="">Selecione um Projeto...</option>` + sistemaOptions;
                arquivoSistemaSelect.innerHTML = `<option value="">Selecione um Projeto...</option>` + sistemaOptions;
                
                updateFuncionalidadeSelects();
            }

            function updateFuncionalidadeSelects() {
                const selectedSistemaId = String(videoSistemaSelect.value); 
                const funcs = selectedSistemaId 
                    ? state.funcionalidades.filter(f => String(f.sistema_id) === selectedSistemaId)
                    : [];

                const allFuncs = funcs;

                const funcOptions = allFuncs.map(f => `<option value="${f.id}">${f.text} (${f.complexidade || 'N/D'})</option>`).join('');
                videoFuncionalidadeSelect.innerHTML = `<option value="">Selecione uma Funcionalidade...</option>` + funcOptions;
                videoFuncionalidadeSelect.disabled = !selectedSistemaId;
            }
            
            // --- RENDER FUNCTIONS ---

            function renderView() {
                viewVideosEl.classList.add('hidden');
                viewArquivosEl.classList.add('hidden');
                
                navLinks.forEach(link => link.classList.remove('active'));

                if (state.currentView === 'videos') {
                    viewVideosEl.classList.remove('hidden');
                    document.getElementById('nav-videos').classList.add('active');
                    viewTitleEl.textContent = 'Gerenciamento de Vídeos Loom';
                } else if (state.currentView === 'arquivos') {
                    viewArquivosEl.classList.remove('hidden');
                    document.getElementById('nav-arquivos').classList.add('active');
                    viewTitleEl.textContent = 'Gerenciamento de Arquivos e Links';
                }
            }

            function renderListagemVideos() {
                
                // --- 1. Mapeamento para nomes amigáveis (Aplicado a TODOS os vídeos) ---
                const allMappedVideos = state.videos.map(v => {
                    // Nota: Os IDs nos dados de vídeo são strings ou números. Usamos String() para garantir comparação consistente.
                    const sistema = state.sistemas.find(s => String(s.id) === String(v.sistema_id));
                    const funcionalidade = state.funcionalidades.find(f => String(f.id) === String(v.funcionalidade_id));
                    return {
                        ...v,
                        sistema_name: sistema ? sistema.name : 'N/D', 
                        funcionalidade_name: funcionalidade ? funcionalidade.text : 'N/D',
                        formatted_date: formatDate(v.data_gravacao),
                    };
                });
                
                let filteredVideos = allMappedVideos;
                
                // --- 2. Aplica Filtros ---
                if (state.filterSistemaId) {
                    filteredVideos = filteredVideos.filter(v => String(v.sistema_id) === state.filterSistemaId);
                }
                if (state.filterTag) {
                    filteredVideos = filteredVideos.filter(v => v.tag === state.filterTag);
                }

                videosCountEl.textContent = `(${filteredVideos.length} itens)`;

                // --- 3. Coleta Tags Únicas para o Filtro (baseado em TODOS os vídeos) ---
                const uniqueTags = [...new Set(state.videos.map(v => v.tag).filter(t => t && t.trim() !== ''))].sort();
                
                // --- 4. Renderiza HTML dos Filtros ---
                const sistemaOptionsHtml = state.sistemas.map(s => `<option value="${s.id}" ${state.filterSistemaId === String(s.id) ? 'selected' : ''}>${s.name}</option>`).join('');
                const tagOptionsHtml = uniqueTags.map(tag => `<option value="${tag}" ${state.filterTag === tag ? 'selected' : ''}>${tag}</option>`).join('');

                const filtersHtml = `
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <select id="video-filter-sistema" class="form-select w-full md:w-1/2">
                            <option value="">Filtrar por Projeto...</option>
                            ${sistemaOptionsHtml}
                        </select>
                        <select id="video-filter-tag" class="form-select w-full md:w-1/2">
                            <option value="">Filtrar por Tag...</option>
                            ${tagOptionsHtml}
                        </select>
                    </div>
                `;

                 if (filteredVideos.length === 0) {
                    videoListContainer.innerHTML = filtersHtml + `<p class="text-center text-slate-500 py-4">Nenhum vídeo cadastrado que corresponda aos filtros.</p>`;
                    addVideoFilterListeners();
                    return;
                 }
                 
                 // --- 5. Renderização da Tabela ---
                 const tableHtml = `
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-400">
                            <thead class="text-xs text-slate-300 uppercase bg-slate-700/50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Título</th>
                                    <th scope="col" class="px-6 py-3">Projeto</th>
                                    <th scope="col" class="px-6 py-3">Funcionalidade</th>
                                    <th scope="col" class="px-6 py-3">Tag</th>
                                    <th scope="col" class="px-6 py-3">Data</th>
                                    <th scope="col" class="px-6 py-3 text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredVideos.map(v => `
                                    <tr class="border-b border-slate-700 hover:bg-slate-700/20">
                                        <th scope="row" class="px-6 py-4 font-medium text-white max-w-xs truncate">${v.titulo}</th>
                                        <td class="px-6 py-4">${v.sistema_name}</td>
                                        <td class="px-6 py-4 max-w-xs truncate">${v.funcionalidade_name}</td>
                                        <td class="px-6 py-4">
                                            <span class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-slate-700 text-slate-300">${v.tag || 'Sem Tag'}</span>
                                        </td>
                                        <td class="px-6 py-4">${v.formatted_date}</td>
                                        <td class="px-6 py-4 text-right flex justify-end space-x-2">
                                            <a href="${v.url_loom}" target="_blank" class="text-slate-400 hover:text-white" title="Abrir Link">
                                                <i class="fa-solid fa-up-right-from-square"></i>
                                            </a>
                                            <button data-id="${v.id}" class="edit-video-btn text-amber-500 hover:text-amber-400" title="Editar">
                                                <i class="fa-solid fa-pencil"></i>
                                            </button>
                                            <button data-id="${v.id}" class="delete-video-btn text-red-500 hover:text-red-400" title="Excluir">
                                                <i class="fa-solid fa-trash-can"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                 `;

                 videoListContainer.innerHTML = filtersHtml + tableHtml;

                 // Adiciona listeners aos filtros recém-criados
                 addVideoFilterListeners();

                 // Adiciona listeners para os botões de ação
                 videoListContainer.querySelectorAll('.edit-video-btn').forEach(btn => {
                     btn.addEventListener('click', (e) => showToast(`Funcionalidade de edição (ID: ${e.currentTarget.dataset.id}) será implementada em breve!`));
                 });
                 videoListContainer.querySelectorAll('.delete-video-btn').forEach(btn => {
                     btn.addEventListener('click', (e) => handleDeleteVideo(e.currentTarget.dataset.id));
                 });
            }
            
            function renderListagemArquivos() {
                
                // --- 1. Mapeamento para nomes amigáveis (Aplicado a TODOS os arquivos) ---
                const allMappedArquivos = state.arquivos.map(a => {
                    const sistema = state.sistemas.find(s => String(s.id) === String(a.sistema_id));
                    return {
                        ...a,
                        sistema_name: sistema ? sistema.name : 'N/D', 
                        formatted_date: formatDate(a.data_criacao),
                        icon_class: getIconForUrl(a.url),
                    };
                });
                
                let filteredArquivos = allMappedArquivos;
                
                // --- 2. Aplica Filtros ---
                if (state.filterArquivoSistemaId) {
                    filteredArquivos = filteredArquivos.filter(a => String(a.sistema_id) === state.filterArquivoSistemaId);
                }
                if (state.filterArquivoCategoria) {
                    filteredArquivos = filteredArquivos.filter(a => a.categoria === state.filterArquivoCategoria);
                }

                arquivosCountEl.textContent = `(${filteredArquivos.length} itens)`;

                // --- 3. Coleta Categorias Únicas para o Filtro (baseado em TODOS os arquivos) ---
                const uniqueCategorias = [...new Set(state.arquivos.map(a => a.categoria).filter(c => c && c.trim() !== ''))].sort();
                
                // --- 4. Renderiza HTML dos Filtros ---
                const sistemaOptionsHtml = state.sistemas.map(s => `<option value="${s.id}" ${state.filterArquivoSistemaId === String(s.id) ? 'selected' : ''}>${s.name}</option>`).join('');
                const categoriaOptionsHtml = uniqueCategorias.map(cat => `<option value="${cat}" ${state.filterArquivoCategoria === cat ? 'selected' : ''}>${cat}</option>`).join('');

                const filtersHtml = `
                    <div class="flex flex-col md:flex-row gap-4 mb-4">
                        <select id="arquivo-filter-sistema" class="form-select w-full md:w-1/2">
                            <option value="">Filtrar por Projeto...</option>
                            ${sistemaOptionsHtml}
                        </select>
                        <select id="arquivo-filter-categoria" class="form-select w-full md:w-1/2">
                            <option value="">Filtrar por Categoria...</option>
                            ${categoriaOptionsHtml}
                        </select>
                    </div>
                `;

                 if (filteredArquivos.length === 0) {
                    arquivoListContainer.innerHTML = filtersHtml + `<p class="text-center text-slate-500 py-4">Nenhum arquivo cadastrado que corresponda aos filtros.</p>`;
                    addArquivoFilterListeners();
                    return;
                 }
                 
                 // --- 5. Renderização da Tabela ---
                 const tableHtml = `
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-400">
                            <thead class="text-xs text-slate-300 uppercase bg-slate-700/50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Título</th>
                                    <th scope="col" class="px-6 py-3">Projeto</th>
                                    <th scope="col" class="px-6 py-3">Categoria</th>
                                    <th scope="col" class="px-6 py-3">Descrição</th>
                                    <th scope="col" class="px-6 py-3">Data</th>
                                    <th scope="col" class="px-6 py-3 text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredArquivos.map(a => `
                                    <tr class="border-b border-slate-700 hover:bg-slate-700/20">
                                        <th scope="row" class="px-6 py-4 font-medium text-white max-w-xs truncate flex items-center gap-3">
                                            <i class="fa-solid ${a.icon_class} text-amber-400"></i>
                                            ${a.titulo}
                                        </th>
                                        <td class="px-6 py-4">${a.sistema_name}</td>
                                        <td class="px-6 py-4">
                                            <span class="text-[10px] font-bold px-2 py-0.5 rounded-full bg-slate-700 text-slate-300">${a.categoria || 'Sem Categoria'}</span>
                                        </td>
                                        <td class="px-6 py-4 max-w-xs truncate" title="${a.descricao}">${a.descricao || 'N/D'}</td>
                                        <td class="px-6 py-4">${a.formatted_date}</td>
                                        <td class="px-6 py-4 text-right flex justify-end space-x-2">
                                            <a href="${a.url}" target="_blank" class="text-slate-400 hover:text-white" title="Abrir Link">
                                                <i class="fa-solid fa-up-right-from-square"></i>
                                            </a>
                                            <button data-id="${a.id}" class="edit-arquivo-btn text-amber-500 hover:text-amber-400" title="Editar">
                                                <i class="fa-solid fa-pencil"></i>
                                            </button>
                                            <button data-id="${a.id}" class="delete-arquivo-btn text-red-500 hover:text-red-400" title="Excluir">
                                                <i class="fa-solid fa-trash-can"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                 `;

                 arquivoListContainer.innerHTML = filtersHtml + tableHtml;

                 // Adiciona listeners aos filtros recém-criados
                 addArquivoFilterListeners();

                 // Adiciona listeners para os botões de ação
                 arquivoListContainer.querySelectorAll('.edit-arquivo-btn').forEach(btn => {
                     btn.addEventListener('click', (e) => showToast(`Funcionalidade de edição de Arquivo (ID: ${e.currentTarget.dataset.id}) será implementada em breve!`));
                 });
                 arquivoListContainer.querySelectorAll('.delete-arquivo-btn').forEach(btn => {
                     btn.addEventListener('click', (e) => handleDeleteArquivo(e.currentTarget.dataset.id));
                 });
            }

            function addVideoFilterListeners() {
                // Captura os elementos recém-criados
                videoFilterSistemaSelect = document.getElementById('video-filter-sistema');
                videoFilterTagSelect = document.getElementById('video-filter-tag');

                if (videoFilterSistemaSelect) {
                    videoFilterSistemaSelect.addEventListener('change', (e) => {
                        state.filterSistemaId = e.target.value;
                        renderListagemVideos();
                    });
                    videoFilterSistemaSelect.value = state.filterSistemaId;
                }
                if (videoFilterTagSelect) {
                    videoFilterTagSelect.addEventListener('change', (e) => {
                        state.filterTag = e.target.value;
                        renderListagemVideos();
                    });
                    videoFilterTagSelect.value = state.filterTag;
                }
            }
            
            function addArquivoFilterListeners() {
                // Captura os elementos recém-criados
                arquivoFilterSistemaSelect = document.getElementById('arquivo-filter-sistema');
                arquivoFilterCategoriaSelect = document.getElementById('arquivo-filter-categoria');

                if (arquivoFilterSistemaSelect) {
                    arquivoFilterSistemaSelect.addEventListener('change', (e) => {
                        state.filterArquivoSistemaId = e.target.value;
                        renderListagemArquivos();
                    });
                    arquivoFilterSistemaSelect.value = state.filterArquivoSistemaId;
                }
                if (arquivoFilterCategoriaSelect) {
                    arquivoFilterCategoriaSelect.addEventListener('change', (e) => {
                        state.filterArquivoCategoria = e.target.value;
                        renderListagemArquivos();
                    });
                    arquivoFilterCategoriaSelect.value = state.filterArquivoCategoria;
                }
            }


            // --- FORM SUBMISSION LOGIC ---

            async function handleFormVideoSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const saveBtn = document.getElementById('btn-salvar-video');
                
                // 1. Initial Validation Check (Standard HTML5)
                if (!form.reportValidity()) {
                    showToast('Preencha todos os campos obrigatórios (Projeto, Funcionalidade, Título e URL).', true);
                    return; 
                }
                
                // 2. Custom URL Validation
                const loomUrl = form['video-url'].value;
                if (!loomUrl.match(/^https:\/\/www\.loom\.com\/share\/[a-zA-Z0-9]+(\?.*)?$/)) {
                     showToast('URL do Loom inválido. Use o formato https://www.loom.com/share/...', true);
                     return;
                }
                
                // --- START SAVING PROCESS ---
                saveBtn.disabled = true;
                saveBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Salvando...`;


                const payload = {
                    sistema_id: form['video-sistema'].value,
                    funcionalidade_id: form['video-funcionalidade'].value,
                    titulo: form['video-titulo'].value,
                    url_loom: loomUrl,
                    descricao: form['video-descricao'].value,
                    tag: form['video-tag'].value,
                    data_gravacao: new Date().toISOString()
                };


                try {
                    const response = await authenticatedFetch(URLS.saveVideo, { 
                        method: 'POST', 
                        body: JSON.stringify(payload) 
                    });
                    
                    if (!response.ok) {
                         const errorText = await response.text();
                         console.error('API Error:', response.status, errorText);
                         throw new Error(`Falha ao salvar. Detalhes: ${errorText.substring(0, 50)}...`);
                    }
                    
                    showToast('Vídeo salvo com sucesso!');
                    form.reset();
                    updateFuncionalidadeSelects();
                    await fetchInitialData(); // Recarrega os dados para atualizar a lista

                } catch (error) {
                    console.error('Erro no Submit:', error);
                    showToast(error.message || 'Falha ao salvar vídeo. Verifique o console.', true);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = `<i class="fa-solid fa-save"></i> Salvar Vídeo`;
                }
            }

            async function handleFormArquivoSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const saveBtn = document.getElementById('btn-salvar-arquivo');

                // 1. Initial Validation Check (Standard HTML5)
                if (!form.reportValidity()) {
                    showToast('Preencha todos os campos obrigatórios (Projeto, Categoria, Título e URL).', true);
                    return; 
                }
                
                // --- START SAVING PROCESS ---
                saveBtn.disabled = true;
                saveBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Salvando...`;
                
                const payload = {
                    sistema_id: form['arquivo-sistema'].value,
                    titulo: form['arquivo-titulo'].value,
                    url: form['arquivo-url'].value,
                    categoria: form['arquivo-categoria'].value,
                    descricao: form['arquivo-descricao'].value,
                    data_criacao: new Date().toISOString()
                };


                try {
                    const response = await authenticatedFetch(URLS.saveArquivo, { 
                        method: 'POST', 
                        body: JSON.stringify(payload) 
                    });
                    
                    if (!response.ok) {
                         const errorText = await response.text();
                         console.error('API Error:', response.status, errorText);
                         throw new Error(`Falha ao salvar. Detalhes: ${errorText.substring(0, 50)}...`);
                    }

                    showToast('Arquivo salvo com sucesso!');
                    form.reset();
                    await fetchInitialData(); // Recarrega os dados para atualizar a lista
                } catch (error) {
                    console.error('Erro no Submit:', error);
                    showToast(error.message || 'Falha ao salvar arquivo. Verifique o console.', true);
                } finally {
                    btnSalvarArquivo.disabled = false;
                    btnSalvarArquivo.innerHTML = `<i class="fa-solid fa-save"></i> Salvar Arquivo`;
                }
            }

            // --- EVENT LISTENERS ---
            loginFormEl.addEventListener('submit', handleLogin);
            logoutButtonEl.addEventListener('click', handleLogout);
            
            videoSistemaSelect.addEventListener('change', updateFuncionalidadeSelects);
            
            formVideoEl.addEventListener('submit', handleFormVideoSubmit);
            formArquivoEl.addEventListener('submit', handleFormArquivoSubmit);

            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    const view = link.dataset.view;
                    if (state.currentView !== view) {
                        state.currentView = view;
                        renderView();
                    }
                });
            });

            mainModalEl.addEventListener('click', (e) => {
                 if (e.target === mainModalEl) closeModal();
            });


            // --- INITIALIZATION ---
            checkAuth();
        });
    </script>
</body>
</html>