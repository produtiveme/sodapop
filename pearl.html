<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pearl - Mermaid Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            --brand-color: #FF4E00;
        }
        #editor {
            font-family: 'Fira Code', monospace;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background-color: #475569; border-radius: 10px; border: 2px solid #1e293b; }
        ::-webkit-scrollbar-thumb:hover { background-color: #64748b; }
        .form-select, .form-input {
            background-color: #1e293b;
            border: 1px solid #334155;
            color: #cbd5e1;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
        }
        #editor.invalid {
            --tw-ring-color: #ef4444 !important; /* red-500 */
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-300">

    <!-- Login View -->
    <div id="login-view" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-lg p-8 space-y-8 bg-slate-800 rounded-lg shadow-lg">
            <div class="text-center">
                 <img src="https://www.svgrepo.com/show/153086/pearl.svg" class="h-12 w-12 mx-auto filter invert" alt="Pearl Logo">
                <h2 class="mt-6 text-3xl font-bold text-white">Bem-vindo ao Pearl</h2>
                <p class="mt-2 text-sm text-slate-400">Faça login para continuar</p>
            </div>
            <form id="login-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm">
                    <div>
                        <label for="username" class="sr-only">Usuário</label>
                        <input id="username" name="username" type="text" required class="form-input rounded-t-md text-lg p-4 w-full" placeholder="Usuário">
                    </div>
                    <div class="mt-[-1px]">
                        <label for="password" class="sr-only">Senha</label>
                        <input id="password" name="password" type="password" required class="form-input rounded-b-md text-lg p-4 w-full" placeholder="Senha">
                    </div>
                </div>
                 <p id="login-error" class="text-red-400 text-sm text-center hidden"></p>
                <div>
                    <button type="submit" id="login-button" class="group relative w-full flex justify-center py-4 px-4 border border-transparent text-lg font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Entrar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- App View -->
    <div id="app" class="hidden flex-col h-screen">
        <header class="bg-slate-800/80 backdrop-blur-sm border-b-2" style="border-color: var(--brand-color);">
            <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center space-x-3">
                        <img src="https://www.svgrepo.com/show/153086/pearl.svg" class="h-8 w-8 filter invert" alt="Pearl Logo">
                        <h1 class="text-2xl font-bold text-white">Pearl</h1>
                    </div>
                    <div id="main-actions" class="hidden items-center space-x-4">
                        <a href="index.html" class="px-3 py-2 rounded-md text-sm font-medium text-white hover:bg-slate-700">Soda Pop</a>
                        <a href="starpiece.html" class="px-3 py-2 rounded-md text-sm font-medium text-white hover:bg-slate-700">Star Piece</a>
                        <div class="h-8 border-l border-slate-600"></div>
                        <div class="flex items-center gap-2">
                             <label for="sistema-select" class="text-sm font-medium text-slate-400 flex-shrink-0">Sistema:</label>
                             <select id="sistema-select" class="form-select w-64"></select>
                        </div>
                        <button id="new-diagram-btn" class="bg-slate-700 hover:bg-slate-600 text-white font-medium py-2 px-4 rounded-lg flex items-center gap-2 transition-colors">
                            <i class="fa-solid fa-file"></i>
                            Novo
                        </button>
                        <button id="save-diagram-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg flex items-center gap-2 transition-colors">
                            <i class="fa-solid fa-save"></i>
                            Salvar
                        </button>
                        <button id="logout-button" class="text-slate-400 hover:text-white" title="Sair"><i class="fa-solid fa-right-from-bracket"></i></button>
                    </div>
                </div>
            </nav>
        </header>

        <main class="flex-grow grid md:grid-cols-2 gap-4 p-4 container mx-auto">
            <!-- Editor Column -->
            <div class="flex flex-col h-full">
                <textarea id="editor" class="w-full h-full bg-slate-800 border border-slate-700 rounded-lg p-4 resize-none focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900" style="--tw-ring-color: var(--brand-color);" spellcheck="false"></textarea>
            </div>

            <!-- Preview Column -->
            <div class="flex flex-col h-full gap-4">
                <div class="flex items-center gap-4 bg-slate-800 border border-slate-700 rounded-lg p-3">
                     <label for="focus-filter" class="text-sm font-medium text-slate-400 flex-shrink-0">Foco no Componente:</label>
                     <select id="focus-filter" class="form-select w-full">
                         <option value="">Ver Todos</option>
                     </select>
                     <button id="clear-filter-btn" class="bg-slate-700 hover:bg-slate-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">Limpar</button>
                </div>
                <div id="preview-container" class="bg-slate-800 border border-slate-700 rounded-lg p-4 flex-grow flex items-center justify-center overflow-auto">
                    <div id="output" class="w-full h-full flex items-center justify-center"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg hidden transition-opacity duration-300">
        <p id="toast-message"></p>
    </div>

    <!-- Hidden canvas for PNG conversion -->
    <canvas id="canvas" class="hidden"></canvas>

    <!-- Mermaid JS -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

    <script>
        mermaid.initialize({ startOnLoad: false, theme: 'dark' });

        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE ---
            let state = {
                sistemas: [],
                currentSistemaId: null
            };

            // --- DOM ELEMENTS ---
            const loginViewEl = document.getElementById('login-view');
            const appViewEl = document.getElementById('app');
            const loginFormEl = document.getElementById('login-form');
            const loginErrorEl = document.getElementById('login-error');
            const loginButtonEl = document.getElementById('login-button');
            const logoutButtonEl = document.getElementById('logout-button');
            const mainActionsEl = document.getElementById('main-actions');

            const editor = document.getElementById('editor');
            const output = document.getElementById('output');
            const focusFilter = document.getElementById('focus-filter');
            const clearFilterBtn = document.getElementById('clear-filter-btn');
            const sistemaSelect = document.getElementById('sistema-select');
            const saveDiagramBtn = document.getElementById('save-diagram-btn');
            const newDiagramBtn = document.getElementById('new-diagram-btn');
            const toastEl = document.getElementById('toast');
            const toastMessageEl = document.getElementById('toast-message');

            let fullCode = '';

            // --- N8N WEBHOOK URLS ---
            const URLS = {
                login: 'https://work.produ-cloud.com/webhook/envia_login',
                sistemas: 'https://work.produ-cloud.com/webhook/carrega_todos_sistemas',
                updateDiagrama: 'https://work.produ-cloud.com/webhook/atualiza_diagrama_sistema'
            };
            
            const showToast = (message, isError = false) => {
                toastMessageEl.textContent = message;
                toastEl.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
                toastEl.classList.remove('hidden');
                setTimeout(() => { toastEl.classList.add('hidden'); }, 3000);
            };

             // --- AUTHENTICATION ---
            function checkAuth() {
                const user = sessionStorage.getItem('sodapop_user');
                if (user) {
                    loginViewEl.classList.add('hidden');
                    appViewEl.classList.remove('hidden');
                    appViewEl.classList.add('flex');
                    mainActionsEl.classList.remove('hidden');
                    mainActionsEl.classList.add('flex');
                    fetchSistemas();
                } else {
                    loginViewEl.classList.remove('hidden');
                    appViewEl.classList.add('hidden');
                    appViewEl.classList.remove('flex');
                    mainActionsEl.classList.add('hidden');
                    mainActionsEl.classList.remove('flex');
                }
            }

            async function handleLogin(e) {
                e.preventDefault();
                loginButtonEl.disabled = true;
                loginButtonEl.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Entrando...`;
                loginErrorEl.classList.add('hidden');

                const username = loginFormEl.username.value;
                const password = loginFormEl.password.value;

                try {
                    const response = await fetch(URLS.login, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    
                    if (!response.ok) throw new Error('Falha na comunicação com o servidor.');
                    
                    const result = await response.json();
                    const userData = Array.isArray(result) ? result[0] : result;

                    if (userData && userData.id) {
                        sessionStorage.setItem('sodapop_user', JSON.stringify(userData));
                        checkAuth();
                    } else {
                         throw new Error('Usuário ou senha inválidos.');
                    }
                } catch (error) {
                    loginErrorEl.textContent = error.message;
                    loginErrorEl.classList.remove('hidden');
                } finally {
                    loginButtonEl.disabled = false;
                    loginButtonEl.textContent = 'Entrar';
                }
            }

            function handleLogout() {
                sessionStorage.removeItem('sodapop_user');
                checkAuth();
            }

            // --- DATA OPERATIONS ---
            async function fetchSistemas() {
                try {
                    const response = await fetch(URLS.sistemas);
                    if (!response.ok) throw new Error('Falha ao buscar sistemas.');
                    state.sistemas = await response.json();
                    populateSistemaSelect();
                } catch (error) {
                    showToast(error.message, true);
                }
            }

            function populateSistemaSelect() {
                sistemaSelect.innerHTML = '<option value="">Selecione um Sistema...</option>';
                state.sistemas.forEach(sistema => {
                    const option = document.createElement('option');
                    option.value = sistema.id;
                    option.textContent = sistema.name;
                    sistemaSelect.appendChild(option);
                });
            }

            function handleSistemaSelect() {
                const selectedId = sistemaSelect.value;
                state.currentSistemaId = selectedId;
                if (selectedId) {
                    const sistema = state.sistemas.find(s => s.id == selectedId);
                    const code = sistema.diagramCode || `graph TD\n    A[Comece a desenhar o diagrama para: ${sistema.name}]`;
                    editor.value = code;
                    handleEditorInput();
                } else {
                    editor.value = exampleCode;
                    handleEditorInput();
                }
            }

            async function handleSaveDiagram() {
                if (!state.currentSistemaId) {
                    alert('Por favor, selecione um sistema para salvar o diagrama.');
                    return;
                }
                
                saveDiagramBtn.disabled = true;
                saveDiagramBtn.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Salvando...`;

                try {
                    const response = await fetch(URLS.updateDiagrama, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            id: state.currentSistemaId,
                            code: editor.value
                        })
                    });
                    if (!response.ok) throw new Error('Falha ao salvar o diagrama.');
                    
                    const sistema = state.sistemas.find(s => s.id == state.currentSistemaId);
                    if(sistema) sistema.diagramCode = editor.value;

                    showToast('Diagrama salvo com sucesso!');

                } catch (error) {
                     showToast(error.message, true);
                } finally {
                    saveDiagramBtn.disabled = false;
                    saveDiagramBtn.innerHTML = `<i class="fa-solid fa-save"></i> Salvar`;
                }
            }

            function handleNewDiagram() {
                sistemaSelect.value = '';
                state.currentSistemaId = null;
                editor.value = `graph TD\n    A[Novo Diagrama]`;
                handleEditorInput();
            }

            // --- MERMAID LOGIC ---
            const exampleCode = `graph TD
    A[Comece a editar] --> B(Seu Diagrama);
`;

            editor.value = exampleCode;
            fullCode = exampleCode;

            const parseMermaidCode = (code) => {
                const lines = code.split('\n');
                const nodes = new Map();
                const links = [];
                const nodeRegex = /^(\s*)(\w+)(?:\[.*?\]|\(.*?\)|>.*?\]|\{.*?\})?/;
                const linkRegex = /(\w+)\s*--.*-->?\s*(\w+)/;
                const linkWithTextRegex = /(\w+)\s*--\|(.*?)\|--\s*(\w+)/;


                lines.forEach(line => {
                    line = line.trim();
                    if (line.startsWith('%%') || line === '') return;

                    let match = line.match(nodeRegex);
                    if (match && !line.includes('--')) {
                        const id = match[2];
                        if (id !== 'graph' && id !== 'subgraph' && id !== 'end') {
                           nodes.set(id, line);
                        }
                    } else {
                        let linkMatch = line.match(linkWithTextRegex) || line.match(linkRegex);
                        if(linkMatch) {
                            links.push({line: line, from: linkMatch[1], to: linkMatch[3] || linkMatch[2]});
                        }
                    }
                });
                return { nodes, links };
            };
            
            const generateFilteredCode = (focusNodeId, nodes, links) => {
                const header = fullCode.match(/^(graph\s+\w+)/);
                if (!header) return 'graph TD\n  A[No graph type found]';

                const relevantLinks = links.filter(l => l.from === focusNodeId || l.to === focusNodeId);
                const relevantNodeIds = new Set([focusNodeId]);
                relevantLinks.forEach(l => {
                    relevantNodeIds.add(l.from);
                    relevantNodeIds.add(l.to);
                });

                let filteredCode = header[0] + '\n\n';
                relevantNodeIds.forEach(nodeId => {
                    if (nodes.has(nodeId)) {
                        filteredCode += `    ${nodes.get(nodeId)}\n`;
                    } else {
                        filteredCode += `    ${nodeId}\n`;
                    }
                });
                
                filteredCode += '\n';
                
                relevantLinks.forEach(link => {
                    filteredCode += `    ${link.line}\n`;
                });

                return filteredCode;
            };

            const updateFilterOptions = () => {
                 const { nodes } = parseMermaidCode(fullCode);
                 const currentVal = focusFilter.value;
                 focusFilter.innerHTML = '<option value="">Ver Todos</option>';
                 const sortedNodes = [...nodes.keys()].sort();
                 sortedNodes.forEach(nodeId => {
                     const option = document.createElement('option');
                     option.value = nodeId;
                     option.textContent = nodeId;
                     focusFilter.appendChild(option);
                 });
                 focusFilter.value = currentVal;
            };

            const renderMermaid = async () => {
                let codeToRender = fullCode;
                const selectedFocus = focusFilter.value;

                if (selectedFocus) {
                    const { nodes, links } = parseMermaidCode(fullCode);
                    codeToRender = generateFilteredCode(selectedFocus, nodes, links);
                }

                if (!codeToRender.trim()) {
                    output.innerHTML = '<p class="text-slate-500">Comece a digitar seu código Mermaid...</p>';
                    editor.classList.remove('invalid');
                    return;
                }

                try {
                    const uniqueId = `mermaid-graph-${Date.now()}`;
                    await mermaid.parse(codeToRender);
                    const { svg } = await mermaid.render(uniqueId, codeToRender);
                    output.innerHTML = svg;
                    editor.classList.remove('invalid');
                } catch (error) {
                    editor.classList.add('invalid');
                    output.innerHTML = `
                        <div class="text-slate-500 flex flex-col items-center justify-center h-full">
                            <i class="fa-solid fa-triangle-exclamation text-4xl text-yellow-500 mb-4"></i>
                            <p class="font-semibold">Erro de sintaxe no diagrama.</p>
                            <p class="text-xs">Corrija o código no editor.</p>
                        </div>
                    `;
                }
            };

            const handleEditorInput = () => {
                fullCode = editor.value;
                updateFilterOptions();
                renderMermaid();
            };

            
            // --- EVENT LISTENERS ---
            loginFormEl.addEventListener('submit', handleLogin);
            logoutButtonEl.addEventListener('click', handleLogout);
            sistemaSelect.addEventListener('change', handleSistemaSelect);
            saveDiagramBtn.addEventListener('click', handleSaveDiagram);
            newDiagramBtn.addEventListener('click', handleNewDiagram);

            editor.addEventListener('input', handleEditorInput);
            focusFilter.addEventListener('change', renderMermaid);
            clearFilterBtn.addEventListener('click', () => {
                focusFilter.value = '';
                renderMermaid();
            });

            // Initial setup
            checkAuth();
            handleEditorInput();
        });
    </script>
</body>
</html>